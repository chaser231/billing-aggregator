# Cursor Project Rules — Billing Aggregator

## Цель
Сохранять онлайн‑сводку по сотрудникам, корректную бруттизацию НДФЛ (gross‑up) и устойчивое чтение Excel.

## Обязательные правила
1. Таблица сотрудников видна всегда (до загрузки — нули), суммы подтягиваются онлайн при добавлении файлов.
2. НДФЛ строго **gross‑up**:  
   - `pay_to_accounting = base / (1 - rate)`  
   - `ndfl_add = base * rate / (1 - rate)`  
   Не использовать схему «прибавить +rate%».
3. Чтение Excel: авто‑детект строки заголовков (первые 8 строк), маппинг к `CANON_MAP`, удаление дубликатов колонок, фильтр `Итого/Общая сумма`.
4. Исключения не валят приложение: показывать `st.warning`/`st.error` с краткой рекомендацией.
5. Код: PEP8, типы, докстринги; русские подписи в UI; читаемые имена.

## Изменения
- Новые параметры — с дефолтами и обратной совместимостью.
- Интеграции (Google Sheets) — конфиги вне кода (`settings.json`/`.env`). Без них локальная работа не должна ломаться.

## Экспорт
- Ровно 2 листа: `All tasks` (если есть файлы) и `For accounting` (текущий пользовательский порядок).

## Коммиты/PR
- Conventional Commits. В PR: что поменяли, как проверить, влияние на экспорт/формулы.

## Мини‑тесты
- Unit: detect header (3 варианта), canon mapping, фильтр «Итого», формула gross‑up.
- E2E: папка с 5–10 файлами → свод + экспорт, проверка суммы.

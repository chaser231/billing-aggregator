# Billing Aggregator — контекст для разработчиков

## 1) Назначение
Внутренний инструмент для быстрой подготовки двухнедельного биллинга по сотрудникам
из индивидуальных Excel-отчётов. Цель — убрать ручную сводку ~30 файлов, исключить ошибки
и выпускать единый отчёт для бухгалтерии в пару кликов.

### Ключевая бизнес-логика
- Источник данных: Excel-отчёты сотрудников (таблицы как на скрине №1).
- Свод: онлайн-агрегация всех задач и сумм по каждому сотруднику.
- НДФЛ рассчитывается **как gross-up** (бруттизация), т.е. сумма из отчёта считается **нетто**.  
  Формула: `gross = net / (1 - rate)`; `ndfl_add = net * rate / (1 - rate)`.

## 2) Текущее состояние (v0.4)
Готово:
- Streamlit-UI, который:
  - принимает файлы (папка или drag&drop),
  - показывает **живую сводную таблицу** (до загрузки — нули, затем суммы подставляются),
  - считает gross-up НДФЛ,
  - позволяет **менять порядок строк**, удалять/добавлять строки, редактировать ФИО,
  - экспортирует `billing_summary.xlsx` с листами:
    - `All tasks` — конкат всех задач,
    - `For accounting` — текущая таблица с суммами (в пользовательском порядке).
- Нормализация входных таблиц:
  - авто-поиск строки заголовка (первые 8 строк; выбирается наиболее «похожая»),
  - удаление дубликатов колонок,
  - маппинг имён столбцов к канону (`ticket`, `summary`, `total`, …),
  - отбрасывание строк-итогов (`Итого/Общая сумма`),
  - парсинг `assignee` в формат «ФИО (login)» / «ФИО | login» + очистка.

Open points:
- сохранение состояния (последний порядок ФИО и настройки) в `settings.json`,
- интеграция с Google Sheets (импорт «Списка сотрудников», экспорт свода),
- unit-тесты и фикстуры для разных форматов отчётов.

## 3) Архитектура (логика)
```
[Excel файлы сотрудников]
     │  чтение (smart header detection), нормализация колонок,
     │  очистка дубликатов и «Итого»
     ▼
[Единый DataFrame задач ("All tasks")]
     │  groupby по 'assignee_name' → сумма 'total'
     ▼
[Свод по сотрудникам]
     │  gross-up: ndfl_add = net * r / (1 - r)
     │  pay_to_accounting = net / (1 - r)
     ▼
[UI-таблица в заданном порядке] → экспорт в Excel
```

### Канонический маппинг колонок
```python
CANON_MAP = {
  "ticket": ["ticket","ключ","тикет","key","task","тип"],
  "ticket_full": ["ticket_full","ссылка","url","link","ticket url"],
  "priority": ["priority","приоритет"],
  "summary": ["summary","задача","описание","task_summary"],
  "status": ["status","статус"],
  "created_ts": ["created_ts","дата создания","создано","created"],
  "updated_ts": ["updated_ts","обновлено","updated"],
  "assignee": ["assignee","исполнитель","сотрудник","user","owner"],
  "tags": ["tags","теги","utm-term","utm_term"],
  "difficulty": ["difficulty","сложность"],
  "weight": ["weight","вес"],
  "importance": ["importance","важность"],
  "weight_tarif": ["weight_tarif","тариф","тариф_вес","тариф по весу","тариф по задачам"],
  "importance_": ["importance_","важность_"],
  "hero_total": ["hero_total","геро","hero"],
  "resizes_total": ["resizes_total","ресайзы","resizes","resize_total"],
  "total": ["total","итого","сумма","amount"],
  "utm_term": ["utm_term","utm-term","метка","tag"]
}
```

## 4) Стэк и запуск
- Python 3.9+
- `streamlit`, `pandas`, `numpy`, `openpyxl`
- Запуск:
  ```bash
  pip install -r billing_automation_ui/requirements.txt
  streamlit run billing_automation_ui/app.py
  ```
- One‑click: `Start Billing.command` / `Start Billing.bat` (через `python -m streamlit`).

## 5) Заданный порядок сотрудников (дефолт)
```
Арутюнян Артур Арамович
Белозёров Кирилл Сергеевич
Блинова Марина Владимировна
Блиновская Алена Игоревна
Бурмистров Егор Евгеньевич
Бухтов Александр Владимирович
Горелов Алексей Владимирович
Дмитриев Олег Викторович
Долгих Егор Владимирович
Капилети Екатерина Олеговна
Кашин Александр Владимирович
Конакова Дарья Дмитриевна
Корнилов Никита Дмитриевич
Кузнецов Станислав Алексеевич
Курмаков Динар Рамдисович
Курочкин Станислав Евгеньевич
Маслова Анастасия Сергеевна
Новикова Ольга Дмитриевна
Носова Алена Сергеевна
Орлова Яна Юрьевна
Павлова Дарья Олеговна
Панкова Вероника Викторовна
Прекрасная Елена Андреевна
Садовая Виктория Павловна
Сорокина Ольга Олеговна
Сухов Дмитрий Андреевич
Тавадян Вероника Суреновна
Шуварикова Лариса Александровна
Южанина Екатерина Алексеевна
```
> Таблица видна всегда: до загрузки суммы = 0; далее обновляются онлайн.

## 6) Поведение UI
- загрузка: папка или drag&drop `.xlsx`;
- сводная таблица — всегда на экране; суммы появляются по мере загрузки;
- НДФЛ: поле «ставка», дефолт `0.13`, перерасчёт онлайн;
- управление: ↑/↓, удалить, добавить, редактирование ФИО;
- экспорт: кнопка «Сформировать общий отчёт».

## 7) Граничные случаи
- Двухстрочные шапки (строка типов) — удаляем.
- Смещённые заголовки — анализ первых 8 строк.
- Дубликаты колонок — удаляем.
- Итоги `Итого/Общая сумма` — фильтруем.
- Битые файлы — предупреждение пользователю, без падения.

## 8) Структура репозитория (рекомендованная)
```
.
├─ billing_automation_ui/
│  ├─ app.py
│  └─ requirements.txt
├─ scripts/ (опционально one‑click)
│  ├─ mac/Start Billing.command
│  └─ win/Start Billing.bat
├─ docs/
│  ├─ CONTEXT.md
│  └─ cursor-rules.md (копия .cursorrules для чтения в браузере)
├─ tests/ (в планах)
└─ README.md
```

## 9) Roadmap
**Спринт А (готово):**
- [x] Онлайн‑сводка и экспорт, gross‑up, чистка входных файлов.

**Спринт B:**
- [ ] Persist настроек/порядка (`settings.json`).
- [ ] Интеграция Google Sheets (импорт/экспорт).
- [ ] Валидация входных файлов и дружественные подсказки.

**Спринт C:**
- [ ] Unit/E2E тесты, логирование, упаковка в .app/.exe.

## 10) Стандарты
- PEP8, типы, докстринги Google‑стиля, `black` + `isort`.
- Коммиты: Conventional Commits.
- UI/сообщения: русский; ошибки — через `st.warning/error`.
- Экспорт: два листа — `All tasks` и `For accounting`.
